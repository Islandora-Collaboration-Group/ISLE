



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for Islandora Enterprise (ISLE)">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.2.0">
    
    
      
        <title>Varnish - Islandora Enterprise (ISLE)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.750b69bd.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#varnish" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Islandora Enterprise (ISLE)" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Islandora Enterprise (ISLE)
            </span>
            <span class="md-header-nav__topic">
              Varnish
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Islandora Enterprise (ISLE)" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Islandora Enterprise (ISLE)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Get Started" class="md-nav__link">
      Get Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Install ISLE
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Install ISLE
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/host-hardware-requirements/" title="1. Hardware Requirements" class="md-nav__link">
      1. Hardware Requirements
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/host-software-dependencies/" title="2. Software Dependencies" class="md-nav__link">
      2. Software Dependencies
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-demo/" title="3. Demo ISLE Installation" class="md-nav__link">
      3. Demo ISLE Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      4. ISLE Installation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        4. ISLE Installation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-environments/" title="Overview: ISLE Environments" class="md-nav__link">
      Overview: ISLE Environments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-local-new/" title="Local: New Site" class="md-nav__link">
      Local: New Site
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-local-migrate/" title="Local: Migrate Site" class="md-nav__link">
      Local: Migrate Site
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-staging-new/" title="Staging: New Site" class="md-nav__link">
      Staging: New Site
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-staging-migrate/" title="Staging: Migrate Site" class="md-nav__link">
      Staging: Migrate Site
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-production-new/" title="Production: New Site" class="md-nav__link">
      Production: New Site
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-production-migrate/" title="Production: Migrate Site" class="md-nav__link">
      Production: Migrate Site
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install-troubleshooting/" title="Troubleshooting Guide" class="md-nav__link">
      Troubleshooting Guide
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../update/update/" title="Update ISLE" class="md-nav__link">
      Update ISLE
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Appendices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Appendices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/data-persistence/" title="Data Persistence in Docker" class="md-nav__link">
      Data Persistence in Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/installing-module-with-composer/" title="Installing a Drupal Module with Composer" class="md-nav__link">
      Installing a Drupal Module with Composer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/installing-module-with-drush/" title="Installing a Drupal Module with Drush" class="md-nav__link">
      Installing a Drupal Module with Drush
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://docs.google.com/document/d/1r-I9n8mUhlJ5Z-X9AO-RrikhzH6I8bTPIL25LmtRbxE" title="Installing on Google Cloud Platform (Google Doc)" class="md-nav__link">
      Installing on Google Cloud Platform (Google Doc)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/configuring-lets-encrypt/" title="Let's Encrypt: Free SSL Certificates" class="md-nav__link">
      Let's Encrypt: Free SSL Certificates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/open-terminal-in-running-container/" title="Opening a Terminal in a Running Container" class="md-nav__link">
      Opening a Terminal in a Running Container
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/sample-it-department-request/" title="Sample IT Department Request Letter" class="md-nav__link">
      Sample IT Department Request Letter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/install-troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-10" type="checkbox" id="nav-4-10">
    
    <label class="md-nav__link" for="nav-4-10">
      User Stories
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-10">
        User Stories
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/user-story-demo-site/" title="Demo ISLE Installation Example User Story" class="md-nav__link">
      Demo ISLE Installation Example User Story
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/user-story-new-site/" title="New Site Example User Story" class="md-nav__link">
      New Site Example User Story
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/user-story-migration-site/" title="Migration Example User Story" class="md-nav__link">
      Migration Example User Story
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../appendices/redhat/" title="Warning about Red Hat Install" class="md-nav__link">
      Warning about Red Hat Install
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Cookbook Recipes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Cookbook Recipes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cookbook-recipes/isle-cheatsheet-docker-commands/" title="ISLE Cheat Sheet: Docker Commands" class="md-nav__link">
      ISLE Cheat Sheet: Docker Commands
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/contributing/" title="Contributing to ISLE" class="md-nav__link">
      Contributing to ISLE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/about-isle/" title="About ISLE" class="md-nav__link">
      About ISLE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/committers/" title="About Committers" class="md-nav__link">
      About Committers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-4" type="checkbox" id="nav-6-4">
    
    <label class="md-nav__link" for="nav-6-4">
      Contributor Docs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-4">
        Contributor Docs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../contributor-docs/mkdocs/" title="Docs: MkDocs" class="md-nav__link">
      Docs: MkDocs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../contributor-docs/spell-checker/" title="Docs: Spell Checker" class="md-nav__link">
      Docs: Spell Checker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../contributor-docs/style-guide/" title="Docs: Style Guide" class="md-nav__link">
      Docs: Style Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../contributor-docs/release-process/" title="Release Process" class="md-nav__link">
      Release Process
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../contributor-docs/testing-guide/" title="Testing Guide" class="md-nav__link">
      Testing Guide
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/get-help/" title="Get Help" class="md-nav__link">
      Get Help
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Release Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Release Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../release-notes/release-1-3-0/" title="Latest release: 1.3.0" class="md-nav__link">
      Latest release: 1.3.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      Previous releases
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        Previous releases
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../release-notes/release-1-2-0/" title="1.2.0" class="md-nav__link">
      1.2.0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../release-notes/release-1-1-2/" title="1.1.2" class="md-nav__link">
      1.1.2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../release-notes/release-1-1-1/" title="1.1.1" class="md-nav__link">
      1.1.1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../release-notes/release-1-1-0/" title="1.1.0" class="md-nav__link">
      1.1.0
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#use-cases-user-stories" title="Use Cases &amp; User Stories" class="md-nav__link">
    Use Cases &amp; User Stories
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#new-functionality" title="New Functionality" class="md-nav__link">
    New Functionality
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-requirements" title="System Requirements" class="md-nav__link">
    System Requirements
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#isle-images" title="ISLE Images" class="md-nav__link">
    ISLE Images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adoption-process-overview" title="Adoption Process Overview" class="md-nav__link">
    Adoption Process Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#assumptions" title="Assumptions" class="md-nav__link">
    Assumptions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation-instructions" title="Installation Instructions" class="md-nav__link">
    Installation Instructions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#isle-local-development" title="ISLE Local development" class="md-nav__link">
    ISLE Local development
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edits-docker-composeproductionyml-file" title="Edits - docker-compose.production.yml file" class="md-nav__link">
    Edits - docker-compose.production.yml file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#varnish-edits-productionenv-localenv-files" title="Varnish Edits - production.env &amp; local.env file(s)" class="md-nav__link">
    Varnish Edits - production.env &amp; local.env file(s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-to-production-and-staging" title="Deployment to Production and Staging" class="md-nav__link">
    Deployment to Production and Staging
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quick-deployment-to-staging-for-code-parity" title="Quick deployment to Staging for code parity" class="md-nav__link">
    Quick deployment to Staging for code parity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-to-production" title="Deployment to Production" class="md-nav__link">
    Deployment to Production
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-verify-that-varnish-is-working" title="How to verify that Varnish is working" class="md-nav__link">
    How to verify that Varnish is working
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#method-1-visit-your-website-in-a-web-browser" title="Method 1 - Visit your website in a web browser" class="md-nav__link">
    Method 1 - Visit your website in a web browser
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-2-inspect-the-headers-on-one-of-your-sites-webpages" title="Method 2 - Inspect the headers on one of your site's webpages" class="md-nav__link">
    Method 2 - Inspect the headers on one of your site's webpages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-3-curl-a-url-and-review-the-headers" title="Method 3 - Curl a url and review the headers" class="md-nav__link">
    Method 3 - Curl a url and review the headers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-4-backend-tools" title="Method 4 - Backend tools" class="md-nav__link">
    Method 4 - Backend tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-clear-the-varnish-cache" title="How to clear the Varnish cache" class="md-nav__link">
    How to clear the Varnish cache
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#varnish-utilities-and-tools" title="Varnish utilities and tools" class="md-nav__link">
    Varnish utilities and tools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-varnish-the-tick-stack" title="Using Varnish &amp; the TICK stack" class="md-nav__link">
    Using Varnish &amp; the TICK stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uninstallation-instructions" title="Uninstallation Instructions" class="md-nav__link">
    Uninstallation Instructions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#need-help" title="Need help?" class="md-nav__link">
    Need help?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-resources" title="Additional Resources" class="md-nav__link">
    Additional Resources
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="varnish">Varnish</h1>
<h2 id="use-cases-user-stories">Use Cases &amp; User Stories</h2>
<ul>
<li>As a repository administrator, I expect that ISLE allows use of server-side caching to optimize the end-user experience without any input from me.</li>
<li>If I have a complex pages (including Solr search results), then I expect ISLE provides an optional HTTP accelerator to deliver cached versions</li>
<li>
<p><em>Negative user story:</em> I do not expect that this optional HTTP accelerator will necessarily speed up asset delivery. Various Islandora components have their own caches for this purpose. ISLE documentation should, however, direct repository administrators to good resources if they have this use case.</p>
</li>
<li>
<p>As a repository browser, I expect to be able to performantly browse an Islandora site, taking advantage of server-side caching to ensure speedy delivery of frequently-viewed pages.</p>
</li>
<li>
<p>As a repository administrator, I expect to find clear documentation about how and why to configure varnish to meet my repository’s unique needs.</p>
</li>
<li>As a repository administrator, I expect to be able to easily clear the Varnish cache to view changes to the site in real time.</li>
</ul>
<hr />
<h2 id="new-functionality">New Functionality</h2>
<ul>
<li>
<p>The <code>isle-varnish</code> image was built using <a href="https://www.varnish-cache.org/">Varnish</a> software to improve end-user performance when and if Drupal/Apache performance is inadequate for high-traffic production environments. Varnish can help to reduce load on the Apache web server and to increase the responsiveness of the Drupal site and Solr searches.</p>
</li>
<li>
<p>The ISLE Varnish configuration uses an memory (RAM) based cache or <em>malloc</em> with a default setting of <code>256 MB</code> which can and should be increased as needed. If you need to read more about how to use or change Varnish's cache settings, please start <a href="https://varnish-cache.org/docs/4.1/users-guide/storage-backends.html">here</a></p>
</li>
<li>
<p><strong>Please note:</strong> There is a new Docker ENV setting within the <code>production.env</code> which allows users to dynamically increase or decrease the amount of stored materials within the Varnish <em>malloc</em> cache.
    <code>bash
    ## Varnish Cache Memory Allocation
    VARNISH_MALLOC=256m</code></p>
</li>
<li>
<p>The Drupal module <a href="https://www.drupal.org/project/varnish">Varnish</a> will need to be installed on the Drupal / Islandora site to provide further integration between the Varnish container and your website. There is an included script (isle_varnish_drupal_module_installer.sh) to install enable and configure the Drupal module on an existing site found in the ISLE <code>scripts/varnish</code> directory. This script will also include the Drupal <a href="https://www.drupal.org/project/purge">Purge</a> and <a href="https://www.drupal.org/project/expire">Expire</a> modules.</p>
</li>
</ul>
<hr />
<h2 id="system-requirements">System Requirements</h2>
<ul>
<li><a href="https://github.com/Islandora-Collaboration-Group/ISLE">ISLE</a> release version <code>1.3.0</code></li>
<li>
<p><code>git clone https://github.com/Islandora-Collaboration-Group/ISLE.git</code></p>
</li>
<li>
<p>Existing ISLE Local, Staging and Production systems and running websites</p>
</li>
<li>
<p>Existing ISLE git repository</p>
</li>
<li>
<p>Existing Drupal / Islandora git repository</p>
</li>
<li>
<p>Ability to allocate additional free memory to the Varnish container as needed. The tuning and configuration of Varnish can vary based on system resources and traffic, as we recommend that you start out with a smaller memory allocation and test the results.</p>
</li>
<li><strong>Example configuration</strong> for a Production ISLE host server using <code>16 GB</code> of memory.<ul>
<li>Expect to allocate about 40 - 50% of the host server memory for all of the Java / Tomcat based images</li>
<li><code>isle-fedora</code> should have the most e.g. <code>4096 MB</code> or <code>4 GB</code></li>
<li><code>isle-solr</code> should have the second most e.g. <code>2048 MB</code> or <code>2 GB</code></li>
<li><code>isle-imageservices</code> should have the third most e.g. <code>1024 MB</code> or <code>1 GB</code></li>
<li>If using <code>isle-blazegraph</code>, this image should also be using a minimum of <code>4096 MB</code> or <code>4 GB</code> of memory</li>
<li>Keep about <code>2 -3 GB</code> free for the remaining images e.g. <code>isle-apache</code>, <code>isle-mysql</code> etc.</li>
<li>This would leave you roughly <code>1 - 2 GB</code> to allocate to the Varnish cache. Start with <code>256</code> to <code>512 MB</code> and work your way up as needed.</li>
<li>You can adjust the amount that Varnish puts into memory in the supplied <code>.env</code> file<ul>
<li>On the line: <code>VARNISH_MALLOC=256m</code> you can change the amount of memory to a higher value other than the default <code>256</code> Megabytes. We recommend that you start with 1-2 GB for now to tune further as your resources and needs warrant.</li>
</ul>
</li>
</ul>
</li>
<li>There are additional potential memory allocation and tuning recommendations for Varnish from <a href="https://info.varnish-software.com/blog/understanding-varnish-cache-memory-usage">Varnish-software</a></li>
<li>
<p>If you need to read more about how to use or change Varnish's cache settings, please start <a href="https://varnish-cache.org/docs/4.1/users-guide/storage-backends.html">here</a></p>
</li>
<li>
<p><strong>Recommendation</strong> Adding more memory to the Production ISLE host system from the default recommended <code>16 GB</code> might be recommended here if running all optional components e.g. <code>isle-varnish</code>,  <code>isle-blazegraph</code>, the TICK stack, etc.</p>
</li>
<li>
<p>There is no new software required on any ISLE host machine.</p>
</li>
</ul>
<hr />
<h3 id="isle-images">ISLE Images</h3>
<ul>
<li>Following the installation steps below, an enduser will configure  / edit their ISLE running system(s) to ultimately use the following images and tags from Docker-Hub:</li>
</ul>
<table>
<thead>
<tr>
<th>Service</th>
<th>Repository</th>
<th>Tag</th>
</tr>
</thead>
<tbody>
<tr>
<td>Apache</td>
<td><a href="https://cloud.docker.com/u/islandoracollabgroup/repository/docker/islandoracollabgroup/isle-apache/tags">islandoracollabgroup/isle-apache</a></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td>Blazegraph</td>
<td><a href="https://cloud.docker.com/u/islandoracollabgroup/repository/docker/islandoracollabgroup/isle-blazegraph/tags">islandoracollabgroup/isle-blazegraph</a></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td>Fedora</td>
<td><a href="https://cloud.docker.com/u/islandoracollabgroup/repository/docker/islandoracollabgroup/isle-fedora/tags">islandoracollabgroup/isle-fedora</a></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td>Image-services</td>
<td><a href="https://cloud.docker.com/u/islandoracollabgroup/repository/docker/islandoracollabgroup/isle-imageservices">islandoracollabgroup/isle-imageservices</a></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td>MySQL</td>
<td><a href="https://cloud.docker.com/u/islandoracollabgroup/repository/docker/islandoracollabgroup/isle-mysql">islandoracollabgroup/isle-mysql</a></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td>Portainer</td>
<td><a href="https://hub.docker.com/r/portainer/portainer">portainer/portainer</a></td>
<td><code>latest</code></td>
</tr>
<tr>
<td>Solr</td>
<td><a href="https://cloud.docker.com/u/islandoracollabgroup/repository/docker/islandoracollabgroup/isle-solr/tags">islandoracollabgroup/isle-solr</a></td>
<td><code>1.3.0</code></td>
</tr>
<tr>
<td>Traefik</td>
<td><a href="https://hub.docker.com/_/traefik">traefik/traefik</a></td>
<td><code>1.7.9</code></td>
</tr>
<tr>
<td>Varnish</td>
<td><a href="https://cloud.docker.com/u/islandoracollabgroup/repository/docker/islandoracollabgroup/isle-varnish">islandoracollabgroup/isle-varnish</a></td>
<td><code>1.3.0</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="adoption-process-overview">Adoption Process Overview</h2>
<p>The installation instructions below will walk you through how to setup and run the optional Varnish container on only your ISLE Production system to cache assets for highly trafficked Islandora sites in addition to adding new Drupal modules to your existing Production Drupal / Islandora website to interact and manage the Varnish cache.</p>
<p><strong>Please note</strong>: ISLE endusers are of course welcome to run Varnish on their Staging systems if they want but it is recommended that endusers simply test on their Local instances, deploy code changes to both Staging and Production but only run Varnish on their Production ISLE systems.</p>
<ul>
<li>
<p>You'll start by backing up all important data as needed.</p>
</li>
<li>
<p>On your Local ISLE Apache container, you'll run the Varnish installation script and then check in the resulting Drupal code changes into your Islandora / Drupal git repository.</p>
</li>
<li>
<p>Following best practices of "code up and data down", pull the resulting Drupal code changes from your Local upstream to your Staging and Production systems.</p>
</li>
<li>
<p>You'll download ISLE images along with a new ISLE image called <code>isle-varnish</code></p>
</li>
<li>
<p>You'll make additional edits and modifications to the following ISLE configuration files on your Local system, check them into git and then pull the code on your Staging and Production systems.</p>
</li>
<li><code>docker-compose.production.yml</code> &amp;  <code>docker-compose.local.yml</code><ul>
<li>Uncommenting the varnish service section</li>
<li>Commenting out a line in the apache service section</li>
</ul>
</li>
<li>
<p><code>production.env</code> &amp; <code>local.env</code></p>
<ul>
<li>Making any necessary edits to the new Varnish ENV section</li>
</ul>
</li>
<li>
<p>You'll perform a <code>docker-compose pull</code> to pull down any new images.</p>
</li>
<li>
<p>You'll restart your containers with the new services having been added and configured.</p>
</li>
<li>
<p>You'll install the new Drupal module called Varnish.</p>
</li>
<li>
<p>You can employ some of the methods mentioned below to ensure that the new Varnish caching service is working.</p>
</li>
<li>
<p>You can use the production.env to change settings and "tune" the resource allocation for Varnish.</p>
</li>
</ul>
<hr />
<h2 id="installation">Installation</h2>
<h3 id="assumptions">Assumptions</h3>
<ul>
<li>
<p>Prior to installation, enduser will have a running ISLE system using the current release of <code>1.3.0.</code> images.</p>
</li>
<li>
<p>This installation process will give the functionality as stated in the <code>Systems Requirements</code> image table above for <code>Varnish</code> testing and usage.</p>
</li>
<li>
<p>Running ISLE Local, Staging and Production sites and systems with ingested objects and content.</p>
</li>
</ul>
<hr />
<h3 id="installation-instructions">Installation Instructions</h3>
<h4 id="isle-local-development">ISLE Local development</h4>
<ul>
<li>Shut down your running containers on your ISLE Local instance.</li>
<li><code>docker-compose down</code></li>
</ul>
<h4 id="edits-docker-composeproductionyml-file">Edits - docker-compose.production.yml file</h4>
<ul>
<li>Within your <code>docker-compose.production.yml</code> &amp; <code>docker-compose.local.yml</code> files, you'll need to uncomment the following section:</li>
</ul>
<p><strong>Example: docker-compose.local.yml</strong></p>
<pre><code class="bash"># Start - Varnish service section
## (Optional-component): Uncomment lines below to run ISLE with the Varnish cache

#  varnish:
#    image: islandoracollabgroup/isle-varnish:1.3.0
#    container_name: isle-varnish-${CONTAINER_SHORT_ID}
#    env_file:
#      - local.env
#      - .env
#    networks:
#      isle-internal:
#    depends_on:
#      - mysql
#      - fedora
#      - solr
#      - apache
#      - traefik
#    labels:
#      - traefik.docker.network=${COMPOSE_PROJECT_NAME}_isle-internal
#      - traefik.port=6081
#      - traefik.enable=true
#      - &quot;traefik.frontend.rule=Host:${BASE_DOMAIN}; PathPrefix: /, /cantaloupe&quot;
#    logging:
#      driver: syslog
#      options:
#        tag: &quot;{{.Name}}&quot;

# END - Varnish service section
</code></pre>

<p>so that it will now look like this and its formatting should line up appropriately with other ISLE services.</p>
<p><strong>Example: docker-compose.local.yml</strong></p>
<pre><code class="bash"># Start - Varnish service section
## (Optional-component): Uncomment lines below to run ISLE with the Varnish cache

  varnish:
    image: islandoracollabgroup/isle-varnish:1.3.0
    container_name: isle-varnish-${CONTAINER_SHORT_ID}
    env_file:
      - local.env
      - .env
    networks:
      isle-internal:
    depends_on:
      - mysql
      - fedora
      - solr
      - apache
      - traefik
    labels:
      - traefik.docker.network=${COMPOSE_PROJECT_NAME}_isle-internal
      - traefik.port=6081
      - traefik.enable=true
      - &quot;traefik.frontend.rule=Host:${BASE_DOMAIN}; PathPrefix: /, /cantaloupe&quot;
    logging:
      driver: syslog
      options:
        tag: &quot;{{.Name}}&quot;

# END - Varnish service section
</code></pre>

<p><strong>Example: docker-compose.production.yml</strong></p>
<pre><code class="bash"># Start - Varnish service section
## (Optional-component): Uncomment lines below to run ISLE with the Varnish cache

#  varnish:
#    image: islandoracollabgroup/isle-varnish:1.3.0
#    container_name: isle-varnish-${CONTAINER_SHORT_ID}
#    env_file:
#      - production.env
#      - .env
#    networks:
#      isle-internal:
#    depends_on:
#      - mysql
#      - fedora
#      - solr
#      - apache
#      - traefik
#    labels:
#      - traefik.docker.network=${COMPOSE_PROJECT_NAME}_isle-internal
#      - traefik.port=6081
#      - traefik.enable=true
#      - &quot;traefik.frontend.rule=Host:${BASE_DOMAIN}; PathPrefix: /, /cantaloupe&quot;
#    logging:
#      driver: syslog
#      options:
#        tag: &quot;{{.Name}}&quot;

# END - Varnish service section
</code></pre>

<p>so that it will now look like this and its formatting should line up appropriately with other ISLE services.</p>
<p><strong>Example: docker-compose.production.yml</strong></p>
<pre><code class="bash"># Start - Varnish service section
## (Optional-component): Uncomment lines below to run ISLE with the Varnish cache

  varnish:
    image: islandoracollabgroup/isle-varnish:1.3.0
    container_name: isle-varnish-${CONTAINER_SHORT_ID}
    env_file:
      - production.env
      - .env
    networks:
      isle-internal:
    depends_on:
      - mysql
      - fedora
      - solr
      - apache
      - traefik
    labels:
      - traefik.docker.network=${COMPOSE_PROJECT_NAME}_isle-internal
      - traefik.port=6081
      - traefik.enable=true
      - &quot;traefik.frontend.rule=Host:${BASE_DOMAIN}; PathPrefix: /, /cantaloupe&quot;
    logging:
      driver: syslog
      options:
        tag: &quot;{{.Name}}&quot;

# END - Varnish service section
</code></pre>

<ul>
<li>
<p><strong>Please note:</strong> If you <strong>are not</strong> using TICK with your Production system, then you don't need to uncomment the entire <code>logging:</code> area and lines. Leave them uncommented.</p>
</li>
<li>
<p>Comment out the last line in your <code>apache</code> service <code>labels</code> section so that Varnish can "take over" handling and routing web traffic.</p>
</li>
</ul>
<pre><code class="bash">    labels:
      - traefik.docker.network=${COMPOSE_PROJECT_NAME}_isle-internal
      - traefik.enable=true
    #  - &quot;traefik.frontend.rule=Host:${BASE_DOMAIN}; PathPrefix: /, /adore-djatoka, /cantaloupe&quot;
</code></pre>

<ul>
<li>No change to traefik service: the varnish service now handles web traffic to your main domain.</li>
</ul>
<hr />
<h4 id="varnish-edits-productionenv-localenv-files">Varnish Edits - production.env &amp; local.env file(s)</h4>
<ul>
<li>Within your <code>production.env</code> and <code>local.env</code> file`, you'll need to uncomment the following section and lines so that:</li>
</ul>
<pre><code class="bash">## Varnish
## Varnish Admin port is 6082
## varnish is substituted for default value of localhost to be open to apache
## otherwise Drupal varnish module cannot connect via CLI
#VARNISH_ADMIN=varnish
#VARNISH_ADMIN_PORT=6082
## Varnish backend
## the apache service is the &quot;backend&quot; for varnish
#VARNISH_BACKEND=apache
#VARNISH_BACKEND_PORT=80
## Varnish Cache Memory Allocation
#VARNISH_MALLOC=256m
## Maximum amount of connections
#VARNISH_MAX_CONNECTIONS=300
## Varnish secret aka Control key
#VARNISH_SECRET=isle_varnish_secret
## Varnish port
#VARNISH_VARNISH_PORT=6081
</code></pre>

<p>becomes:</p>
<pre><code class="bash">## Varnish
## Varnish Admin port is 6082
## varnish is substituted for default value of localhost to be open to apache
## otherwise Drupal varnish module cannot connect via CLI
VARNISH_ADMIN=varnish
VARNISH_ADMIN_PORT=6082
## Varnish backend
## the apache service is the &quot;backend&quot; for varnish
VARNISH_BACKEND=apache
VARNISH_BACKEND_PORT=80
## Varnish Cache Memory Allocation
VARNISH_MALLOC=256m
## Maximum amount of connections
VARNISH_MAX_CONNECTIONS=300
## Varnish secret aka Control key
VARNISH_SECRET=isle_varnish_secret
## Varnish port
VARNISH_VARNISH_PORT=6081
</code></pre>

<ul>
<li><strong>Please note</strong> ISLE endusers should only make edits or changes to the following lines:</li>
<li>
<p>VARNISH_MALLOC=256m - <em>you can increase this default setting as needed otherwise leave the default.</em></p>
</li>
<li>
<p>VARNISH_MAX_CONNECTIONS=300 - <em>you can increase this default setting as needed otherwise leave the default.</em></p>
</li>
<li>
<p>VARNISH_SECRET=isle_varnish_secret - <em>you can change this value to any alpha-numeric sequence.</em></p>
</li>
</ul>
<hr />
<ul>
<li>Pull down the new isle images</li>
<li>
<p><code>docker-compose pull</code></p>
</li>
<li>
<p>Spin up new containers</p>
</li>
<li>
<p><code>docker-compose up -d</code></p>
</li>
<li>
<p>Install the Varnish Drupal modules on your Local Drupal site</p>
</li>
<li>
<p>Use the supplied installer script: (<em>Examples given below, you may need to change container ids and paths accordingly to match your local environment</em>)</p>
<ul>
<li>On the Production host server, copy this script to your apache container. Replace <code>{{ container_short_id }}</code> with your respective Local container id.</li>
<li><code>docker cp scripts/varnish/isle_varnish_drupal_module_installer.sh isle-apache-{{ container_short_id }}:/var/www/html/isle_varnish_drupal_installer.sh</code></li>
<li>Change permissions on the script</li>
<li><code>docker exec isle-apache-{{ container_short_id }} bash -c "cd /var/www/html/ &amp;&amp; chmod +x isle_varnish_drupal_installer.sh"</code></li>
<li>Run the script</li>
<li><code>docker exec isle-apache-{{ container_short_id }} bash -c "cd /var/www/html &amp;&amp; ./isle_varnish_drupal_installer.sh"</code></li>
</ul>
</li>
<li>
<p>Commit the changed files to your Islandora / Drupal git repository.</p>
</li>
<li>Navigate to this path on your Local host machine, typically this is the path bind-mounted in your <code>docker-compose.local.yml</code> to the Apache container's <code>/var/www/html</code> directory</li>
<li><code>git status</code> - this will show you all of the changed files.</li>
<li><code>git add path/file</code> - add each changed file as necessary</li>
<li><code>git commit -m "Adding Varnish Drupal modules"</code> - Your git message can be anything of your choosing</li>
<li>
<p><code>git push origin your_git_branch</code> - Replace <code>your_git_branch</code> with the actual git branch you are using for Islandora / Drupal development</p>
</li>
<li>
<p>You can now access this new module in the <code>Home &gt;&gt; Administration &gt;&gt; Configuration &gt;&gt; Development &gt;&gt; Varnish</code> section of your Drupal site.</p>
</li>
<li>
<p>Please note: We recommend the following settings. All other settings should be handled by the vsets within the installer script.</p>
<ul>
<li><code>Flush page cache on cron?</code> set to <code>Disabled</code></li>
<li><code>Varnish version</code> set to <code>4.x</code></li>
<li><code>Varnish Control Key Append newline</code> checkbox should be <code>checked</code> with a <code>check mark</code></li>
<li><code>The Front domains list</code> can be left empty</li>
<li><code>Varnish Cache Clearing</code> set to <code>Drupal Default</code></li>
<li><code>Varnish ban type</code> set to <code>Normal</code></li>
</ul>
</li>
<li>
<p>All other settings e.g. <code>Varnish Control Terminal</code> and <code>Varnish Control Key</code> are handled by the local.env ENV variables. (<em>if testing on local</em>)</p>
</li>
<li>
<p>There will also be two other new Drupal modules to access and use:</p>
</li>
<li><strong>Purge</strong> - Accessible from <code>Home » Administration » Configuration » Development » Performance</code><ul>
<li>The setting here is handled by the installer script, vset and Varnish ENV. No need to change this value by the enduser.</li>
</ul>
</li>
<li>
<p><strong>Cache Expiration</strong> - Accessible from <code>Home » Administration » Configuration » System</code></p>
<ul>
<li>The setting here is initially handled by the installer script, vset and Varnish ENV. Enduser can modify as needed but a further explination beyond default settings is out of scope of this document. Recommend using this Drupal modules help page if needed.</li>
</ul>
</li>
<li>
<p>There should be a nice green checkmark at the bottom to indicate <code>Varnish running</code> once / if you have also spun up the Varnish container. If you choose to not spin up and configure the Varnish container on your Local, your Local ISLE system will continue to run properly but these three Drupal modules may have a red warning or two about not being able to connect to Varnish.</p>
</li>
<li>
<p>If testing Varnish on your Local, open up a web browser and navigate to your Local website.</p>
</li>
<li>If you recently restarted your Docker containers, this may take a few minutes depending on the size of the site.<ul>
<li>You might first see a Traefik <code>Bad Gateway</code> page for a minute or two. You'll need to refresh the page.</li>
<li>You might then see a Varnish followed by a <code>Error 503 Backend fetch failed</code> page for a minute or two. You'll need to again refresh the page.</li>
<li>Example Varnish error upon site startup.</li>
<li>You should now see your Drupal website after a few minutes.  </li>
</ul>
</li>
</ul>
<p><strong>Example Varnish error</strong></p>
<pre><code class="bash">Error 503 Backend fetch failed

Backend fetch failed
Guru Meditation:

XID: 3

Varnish cache server
</code></pre>

<ul>
<li>
<p>If continuing to test on your Local, please review the section below <code>How to verify that Varnish is working</code> for available testing methods.</p>
</li>
<li>
<p>Once satisfied that everything is running properly on your Local, move onto the <code>Deployment to Production and Staging</code> section.</p>
</li>
</ul>
<hr />
<h4 id="deployment-to-production-and-staging">Deployment to Production and Staging</h4>
<ul>
<li>
<p>Once satisfied that everything is running properly on your Local, you'll need to commit all remaining ISLE config changes as well to push upstream to your Production instance. While you can keep Varnish running on your local, we suggest that you instead back out the ISLE config changes on your Local and only keep them on Production.</p>
</li>
<li>
<p>Commit the changed files to your ISLE git repository.</p>
</li>
<li>Navigate to the root of your ISLE project via a terminal or git GUI client.</li>
<li><code>git status</code> - this will show you all of the changed files.</li>
<li><code>git add path/file</code> - add each changed file as necessary</li>
<li><code>git commit -m "Adding Varnish to Production"</code> - Your git message can be anything of your choosing</li>
<li><code>git push origin master</code> - (<em>Replace <code>master</code> with the actual git branch you are using for ISLE development if needed</em>)</li>
</ul>
<h5 id="quick-deployment-to-staging-for-code-parity">Quick deployment to Staging for code parity</h5>
<ul>
<li>On your Staging system:</li>
<li>Shutdown your containers from your ISLE project directory root found typically in <code>/opt/</code><ul>
<li><code>docker-compose down</code></li>
</ul>
</li>
<li>Run <code>git pull origin master</code> - (<em>Replace <code>master</code> with the actual git branch you are using for ISLE development if needed</em>)<ul>
<li>While you may not be deploying Varnish to your Staging system, it is a wise idea to not have code drift.</li>
</ul>
</li>
<li>Repeat this process with your Islandora / Drupal code to ensure parity between Staging and Production</li>
<li>Spin your containers back up</li>
<li>Run the supplied installer script: (<em>Examples given below, you may need to change container ids and paths accordingly to match your Staging environment</em>)<ul>
<li>On the Staging host server, copy this script to your apache container. Replace <code>{{ container_short_id }}</code> with your respective Staging container id.</li>
<li><code>docker cp scripts/varnish/isle_varnish_drupal_module_installer.sh isle-apache-{{ container_short_id }}:/var/www/html/isle_varnish_drupal_installer.sh</code></li>
<li>Change permissions on the script</li>
<li><code>docker exec isle-apache-{{ container_short_id }} bash -c "cd /var/www/html/ &amp;&amp; chmod +x isle_varnish_drupal_installer.sh"</code></li>
<li>Run the script</li>
<li><code>docker exec isle-apache-{{ container_short_id }} bash -c "cd /var/www/html &amp;&amp; ./isle_varnish_drupal_installer.sh"</code></li>
<li>The script will complain about the Drupal modules being enabled but will complete.</li>
</ul>
</li>
<li>Perform a quick QC of the site and system to ensure no issues have resulted. Once finished move onto deploying to Production</li>
</ul>
<h5 id="deployment-to-production">Deployment to Production</h5>
<ul>
<li>On your Production system:</li>
<li>Shutdown your containers from your ISLE project directory root found typically in <code>/opt/</code><ul>
<li><code>docker-compose down</code></li>
</ul>
</li>
<li>Run <code>git pull origin master</code> - (<em>Replace <code>master</code> with the actual git branch you are using for ISLE development if needed</em>)</li>
<li>
<p>Repeat this process with your Islandora / Drupal code using the appropriate git branch as needed</p>
</li>
<li>
<p>Pull down the new isle images</p>
</li>
<li>
<p><code>docker-compose pull</code></p>
</li>
<li>
<p>Spin up new containers</p>
</li>
<li>
<p><code>docker-compose up -d</code></p>
</li>
<li>
<p>Run the supplied installer script: (<em>Examples given below, you may need to change container ids and paths accordingly to match your Production environment</em>)</p>
</li>
<li>On the Production host server, copy this script to your apache container. Replace <code>{{ container_short_id }}</code> with your respective Staging container id.<ul>
<li><code>docker cp scripts/varnish/isle_varnish_drupal_module_installer.sh isle-apache-{{ container_short_id }}:/var/www/html/isle_varnish_drupal_installer.sh</code></li>
</ul>
</li>
<li>Change permissions on the script<ul>
<li><code>docker exec isle-apache-{{ container_short_id }} bash -c "cd /var/www/html/ &amp;&amp; chmod +x isle_varnish_drupal_installer.sh"</code></li>
</ul>
</li>
<li>Run the script<ul>
<li><code>docker exec isle-apache-{{ container_short_id }} bash -c "cd /var/www/html &amp;&amp; ./isle_varnish_drupal_installer.sh"</code></li>
</ul>
</li>
<li>
<p>The script will complain about the Drupal modules being enabled but will complete.</p>
</li>
<li>
<p>You can now access this new module in the <code>Home &gt;&gt; Administration &gt;&gt; Configuration &gt;&gt; Development &gt;&gt; Varnish</code> section of your Drupal site.</p>
</li>
<li>
<p>Please note: We recommend the following settings. All other settings should be handled by the vsets within the installer script.</p>
<ul>
<li><code>Flush page cache on cron?</code> set to <code>Disabled</code></li>
<li><code>Varnish version</code> set to <code>4.x</code></li>
<li><code>Varnish Control Key Append newline</code> checkbox should be <code>checked</code> with a <code>check mark</code></li>
<li><code>The Front domains list</code> can be left empty</li>
<li><code>Varnish Cache Clearing</code> set to <code>Drupal Default</code></li>
<li><code>Varnish ban type</code> set to <code>Normal</code></li>
</ul>
</li>
<li>
<p>All other settings e.g. <code>Varnish Control Terminal</code> and <code>Varnish Control Key</code> are handled by the production.env ENV variables.</p>
</li>
<li>
<p>There will also be two other new Drupal modules to access and use:</p>
</li>
<li><strong>Purge</strong> - Accessible from <code>Home » Administration » Configuration » Development » Performance</code><ul>
<li>The setting here is handled by the installer script, vset and Varnish ENV. No need to change this value by the enduser.</li>
</ul>
</li>
<li>
<p><strong>Cache Expiration</strong> - Accessible from <code>Home » Administration » Configuration » System</code></p>
<ul>
<li>The setting here is initially handled by the installer script, vset and Varnish ENV. Enduser can modify as needed but a further explination beyond default settings is out of scope of this document. Recommend using this Drupal modules help page if needed.</li>
</ul>
</li>
<li>
<p>There should be a nice green checkmark at the bottom to indicate <code>Varnish running</code> once / if you have also spun up the Varnish container. If any of the three Drupal modules have a red warning or two about not being able to connect to Varnish, then you'll need to retrace your steps and troubleshoot.</p>
</li>
<li>
<p>Open up a web browser and navigate to your Production website.</p>
</li>
<li>If you recently restarted your Docker containers, this may take a few minutes depending on the size of the site.<ul>
<li>You might first see a Traefik <code>Bad Gateway</code> page for a minute or two. You'll need to refresh the page.</li>
<li>You might then see a Varnish followed by a <code>Error 503 Backend fetch failed</code> page for a minute or two. You'll need to again refresh the page.</li>
<li>Example Varnish error upon site startup.</li>
<li>You should now see your Drupal website after a few minutes.  </li>
</ul>
</li>
</ul>
<p><strong>Example Varnish error</strong></p>
<pre><code class="bash">Error 503 Backend fetch failed

Backend fetch failed
Guru Meditation:

XID: 3

Varnish cache server
</code></pre>

<ul>
<li>
<p>If continuing to test on your Production system, please review the section below <code>How to verify that Varnish is working</code> for available testing methods.</p>
</li>
<li>
<p>We also recommend a final QC on your Production system, reviewing all logs, displayed objects and searches.</p>
</li>
</ul>
<hr />
<h2 id="how-to-verify-that-varnish-is-working">How to verify that Varnish is working</h2>
<p>Any of these methods below will work for testing on your Local or general use on Production</p>
<h3 id="method-1-visit-your-website-in-a-web-browser">Method 1 - Visit your website in a web browser</h3>
<ul>
<li>
<p>Open up a web browser and navigate to your website.</p>
</li>
<li>
<p>If you recently restarted your Docker containers, this may take a few minutes depending on the size of the site.</p>
</li>
<li>You might first see a Traefik <code>Bad Gateway</code> page for a minute or two. You'll need to refresh the page.</li>
<li>You might then see a Varnish followed by a <code>Error 503 Backend fetch failed</code> page for a minute or two. You'll need to again refresh the page.<ul>
<li>Example Varnish error upon site startup.</li>
</ul>
</li>
</ul>
<pre><code class="bash">Error 503 Backend fetch failed

Backend fetch failed
Guru Meditation:

XID: 3

Varnish cache server
</code></pre>

<ul>
<li>You should now see your website after a few minutes.</li>
</ul>
<h3 id="method-2-inspect-the-headers-on-one-of-your-sites-webpages">Method 2 - Inspect the headers on one of your site's webpages</h3>
<ul>
<li>
<p>Launch a web browser (<em>Chrome., Safari or Firefox</em>) and navigate to your website</p>
</li>
<li>
<p>To inspect the headers, right click on the page and choose <code>Inspect</code></p>
</li>
<li>
<p>This should launch the browser's built-in tools suite, select <code>Network</code></p>
</li>
<li>You'll need to refresh / reload the page again to see objects</li>
<li>Look for the page url and click on it.<ul>
<li>Your should see entries like the following:</li>
</ul>
</li>
</ul>
<pre><code class="bash">via: 1.1 varnish-v4
x-cache: HIT
x-cache-hits: 2
</code></pre>

<h3 id="method-3-curl-a-url-and-review-the-headers">Method 3 - Curl a url and review the headers</h3>
<ul>
<li>Run a curl command on your local laptop to your site with <code>curl -I https://yourwebsitehere.com</code></li>
</ul>
<p>The output should look something like this example output below:</p>
<pre><code class="bash">curl -I https://demo.born-digital.com

HTTP/2 200 
accept-ranges: bytes
age: 2075
cache-control: public, max-age=10800
content-language: en
content-type: text/html; charset=utf-8
date: Mon, 23 Sep 2019 19:27:42 GMT
etag: W/&quot;1569264015-0-gzip&quot;
expires: Sun, 19 Nov 1978 05:00:00 GMT
last-modified: Mon, 23 Sep 2019 18:40:15 GMT
server: Apache/2.4.41 (Ubuntu)
vary: Cookie,Accept-Encoding
via: 1.1 varnish-v4
x-cache: HIT
x-cache-hits: 19
x-content-type-options: nosniff
x-drupal-cache: HIT
x-frame-options: SAMEORIGIN
x-generator: Drupal 7 (http://drupal.org)
x-varnish: 983097 3
</code></pre>

<p><strong>Please note:</strong> This information below is a callout for the enduser to understand indicates that Varnish is not only caching the page but the Varnish cache has received previous "hits" or requests for this page and its contents.</p>
<pre><code class="bash">via: 1.1 varnish-v4
x-cache: HIT
x-cache-hits: 19
</code></pre>

<h3 id="method-4-backend-tools">Method 4 - Backend tools</h3>
<ul>
<li>You can use tools like <code>varnishtop</code>, <code>varnishstat</code>, <code>varnishlog</code> or <code>varnishhist</code> to view traffic on the Varnish container.</li>
<li>Please navigate down to the <code>Varnish utilities and tools</code> section for more details.</li>
</ul>
<hr />
<h2 id="how-to-clear-the-varnish-cache">How to clear the Varnish cache</h2>
<ul>
<li>
<p>Everytime the Varnish container is stopped and restarted, the Varnish cache will be reset and rebuilt. (<em>Easiest and most recommended method</em>)</p>
</li>
<li>
<p>Shell into the Varnish container (<em>Shouldn't involve restarting the container</em>). Replace <code>{{ container_short_id }}</code> with your respective container id.</p>
</li>
<li><code>docker exec -it isle-varnish-{{ container_short_id }} bash</code></li>
<li>
<p><code>varnishadm -T 127.0.0.1:6082 url.purge .</code></p>
</li>
<li>
<p>Additional curl commands and vcl edits can be found within the <a href="https://varnish-cache.org/docs/4.1/users-guide/purging.html">Varnish 4.1 documentation</a></p>
</li>
</ul>
<h2 id="varnish-utilities-and-tools">Varnish utilities and tools</h2>
<p>There are multiple tools that can be used to interacte with the Varnish cache. All will require that you use them on the running Varnish container.</p>
<ul>
<li><a href="https://varnish-cache.org/docs/4.1/reference/varnishlog.html">varnishtop</a> - The varnishtop utility reads varnishd shared memory logs and presents a continuously updated list of the most commonly occurring log entries.</li>
<li><a href="https://varnish-cache.org/docs/4.1/reference/varnishstat.html#varnishstat-1">varnishstat</a> - for Varnish cache statistics</li>
<li><a href="https://varnish-cache.org/docs/4.1/reference/varnishlog.html">varnishlog</a> - a utility that can read the contents of the in-memory log that Varnish provides</li>
<li><a href="https://varnish-cache.org/docs/4.1/reference/varnishhist.html">varnishhist</a> - The varnishhist utility reads varnishd(1) shared memory logs and presents a continuously updated histogram</li>
<li><a href="https://varnish-cache.org/docs/4.1/reference/varnishadm.html">varnishadm</a> - type in <code>varnishadm</code> and then <code>help</code> for additional commands. Utility used to control the Varnish cache.</li>
<li>Additional commands can be found in the <a href="https://varnish-cache.org/docs/4.1/users-guide/operation-statistics.html">Varnish Reporting &amp; Statistics section</a></li>
</ul>
<hr />
<h2 id="using-varnish-the-tick-stack">Using Varnish &amp; the TICK stack</h2>
<ul>
<li>
<p>Please first follow the instructions for installing and using the <a href="../tickstack/">TICK stack</a></p>
</li>
<li>
<p>If you're pushing log events to <a href="../tickstack/">TICK</a>, this snippet of code below (<em>logging instructions</em>) at the bottom of <strong>every</strong> ISLE service within your <code>docker-compose.production.yml</code> file should be uncommented. This should include the Varnish service. By default the uncommented Varnish section in the Production <code>docker-compose.production.yml</code> file will have this snippet of code below.</p>
</li>
</ul>
<pre><code class="bash">    logging:
      driver: syslog
      options:
        tag: &quot;{{.Name}}&quot;
</code></pre>

<p><strong><em>*Example:</em></strong>*</p>
<pre><code class="bash">varnish:
  image: islandoracollabgroup/isle-varnish:1.3.0
  container_name: isle-varnish-${CONTAINER_SHORT_ID}
  env_file:
    - .env
  networks:
    isle-internal:
  depends_on:
    - mysql
    - fedora
    - solr
    - apache
    - traefik
  labels:
    - traefik.docker.network=${COMPOSE_PROJECT_NAME}_isle-internal
    - traefik.port=6081
    - traefik.enable=true
    - &quot;traefik.frontend.rule=Host:${BASE_DOMAIN}; PathPrefix: /, /adore-djatoka, /cantaloupe&quot;
  logging:
    driver: syslog
    options:
      tag: &quot;{{.Name}}&quot;
</code></pre>

<hr />
<h2 id="uninstallation-instructions">Uninstallation Instructions</h2>
<ul>
<li>Shutdown the ISLE containers on your Local system</li>
<li>Comment out the Varnish service section in either of the <code>docker-compose.production.yml</code> or <code>docker-compose.local.yml</code> file(s)<ul>
<li>Uncomment the last line in the Apache <code>labels</code> section in either of the <code>docker-compose.production.yml</code> or <code>docker-compose.local.yml</code> file(s)</li>
</ul>
</li>
<li>Comment out the Varnish section again in the <code>production.env</code> or <code>local.env</code> file</li>
<li>Startup the ISLE containers again.</li>
<li>Shell into the Apache container</li>
<li><code>cd /var/www/html</code></li>
<li><code>drush dis varnish purge expire</code></li>
<li><code>drush pm-uninstall varnish purge expire</code></li>
<li>Commit the resulting code changes in both the ISLE and Islandora git repositories.</li>
<li>Deploy these changes to your Staging and Production systems</li>
</ul>
<hr />
<h2 id="need-help">Need help?</h2>
<ul>
<li>
<p>Please use the following as resources for institutions or endusers needing support</p>
</li>
<li>
<p><a href="https://github.com/islandora-interest-groups/Islandora-ISLE-Interest-Group">Islandora ISLE Interest Group</a> - Meetings open to everybody!</p>
<ul>
<li>The <a href="https://github.com/islandora-interest-groups/Islandora-ISLE-Interest-Group/#how-to-join">Schedule</a> is alternating Wednesdays, 3:00pm EDT</li>
</ul>
</li>
<li>
<p><a href="https://groups.google.com/forum/#!forum/islandora-isle">Islandora ISLE Google group</a> - Post your questions here and subscribe for updates, meeting announcements, and technical support</p>
</li>
<li>
<p><a href="https://github.com/Islandora-Collaboration-Group/ISLE/issues">ISLE Github Issues queue</a> - Post your issues, bugs and requests for technical documentation here.</p>
</li>
</ul>
<hr />
<h2 id="additional-resources">Additional Resources</h2>
<ul>
<li>
<p><a href="https://varnish-cache.org/docs/4.1/index.html">Varnish 4.1.x Documentation</a></p>
</li>
<li>
<p><a href="https://varnish-cache.org/docs/4.1/users-guide/index.html">The Varnish Users Guide</a></p>
</li>
<li>
<p><strong>Please note:</strong>:</p>
</li>
<li><a href="https://www.varnish-software.com/">Varnish Software</a> is the commercial wing of the Varnish.<ul>
<li>Varnish Admin Console is a <a href="https://www.varnish-software.com/solutions/varnish-enterprise/varnish-administration-console-2/">paid</a> not for free product that is a GUI for Varnish Cache. The language around this feature is vague and sometimes misleadingly used in tutorials as software anyone can use. There are trials but ultimately this is a paid product.</li>
</ul>
</li>
<li><a href="https://www.varnish-software.com/community/varnish-cache/">Varnish Cache</a> is the open-source project maintained by Varnish Software and intended to be used by anyone for free.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.39abc4af.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../extra.js"></script>
      
    
  </body>
</html>